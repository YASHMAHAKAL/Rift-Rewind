"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_lambda_1 = require("@aws-sdk/client-lambda");
const s3Client = new client_s3_1.S3Client({});
const dynamoClient = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({}));
const lambdaClient = new client_lambda_1.LambdaClient({});
const MATCHES_TABLE = process.env.MATCHES_TABLE;
const RAW_BUCKET = process.env.RAW_BUCKET;
const PROCESSED_BUCKET = process.env.PROCESSED_BUCKET;
// Utility functions (inline to avoid import issues)
function calculateKDA(kills, deaths, assists) {
    return deaths === 0 ? kills + assists : (kills + assists) / deaths;
}
function calculateCSPerMin(cs, durationSeconds) {
    return (cs / durationSeconds) * 60;
}
/**
 * Processing Lambda - Compute stats and create match fragments
 */
const handler = async (event) => {
    console.log('Processing Lambda invoked', { event });
    const { puuid, matchId, region } = event;
    try {
        // 1. Read raw match data from S3
        const s3Key = `${region}/${puuid}/${matchId}.json`;
        const getCommand = new client_s3_1.GetObjectCommand({
            Bucket: RAW_BUCKET,
            Key: s3Key,
        });
        const response = await s3Client.send(getCommand);
        const matchData = JSON.parse(await response.Body.transformToString());
        console.log('Retrieved match data', { matchId });
        // 2. Find player's participant data
        const participant = matchData.info.participants.find((p) => p.puuid === puuid);
        if (!participant) {
            throw new Error(`Player ${puuid} not found in match ${matchId}`);
        }
        // 3. Compute statistics
        // CRITICAL: playerId MUST match the format used in ingestion Lambda
        // Ingestion uses: region_puuid.slice(0,8)
        // Example: "KR1_osKuSKIM" not "KR1_Faker"
        const playerId = `${region}_${puuid.slice(0, 8)}`;
        const stats = {
            playerId, // REQUIRED: DynamoDB partition key - MUST match ingestion format!
            matchId,
            puuid,
            championName: participant.championName,
            championId: participant.championId,
            role: participant.teamPosition || participant.individualPosition,
            kills: participant.kills,
            deaths: participant.deaths,
            assists: participant.assists,
            kda: calculateKDA(participant.kills, participant.deaths, participant.assists),
            totalCS: participant.totalMinionsKilled + participant.neutralMinionsKilled,
            csPerMin: calculateCSPerMin(participant.totalMinionsKilled + participant.neutralMinionsKilled, matchData.info.gameDuration),
            goldEarned: participant.goldEarned,
            damageDealt: participant.totalDamageDealtToChampions,
            damageTaken: participant.totalDamageTaken,
            visionScore: participant.visionScore,
            win: participant.win,
            gameDuration: matchData.info.gameDuration,
            gameMode: matchData.info.gameMode,
            queueId: matchData.info.queueId,
            gameCreation: matchData.info.gameCreation,
            timestamp: new Date(matchData.info.gameCreation).toISOString(),
        };
        // 4. Create match fragments for RAG (early/mid/late game analysis)
        const fragments = createMatchFragments(matchData, participant, stats);
        // 5. Store match stats in DynamoDB
        await dynamoClient.send(new lib_dynamodb_1.PutCommand({
            TableName: MATCHES_TABLE,
            Item: {
                ...stats,
                ttl: Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60, // 30 days
            },
        }));
        console.log('Stored match in DynamoDB', { matchId });
        // 6. Store fragments in processed bucket
        const fragmentsKey = `${region}/${puuid}/${matchId}-fragments.json`;
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: PROCESSED_BUCKET,
            Key: fragmentsKey,
            Body: JSON.stringify(fragments),
            ContentType: 'application/json',
        }));
        console.log('Stored fragments in S3', { fragmentsKey });
        // 7. Trigger AI Lambda for insight generation (async)
        try {
            await lambdaClient.send(new client_lambda_1.InvokeCommand({
                FunctionName: 'rift-rewind-ai',
                InvocationType: 'Event', // Async invoke
                Payload: JSON.stringify({
                    puuid,
                    matchId,
                    region,
                    fragmentsKey,
                }),
            }));
            console.log('Triggered AI Lambda', { matchId });
        }
        catch (error) {
            console.warn('Failed to trigger AI Lambda (non-critical):', error);
        }
        console.log('Processing complete', { matchId });
    }
    catch (error) {
        console.error('Error in processing:', error);
        throw error;
    }
};
exports.handler = handler;
/**
 * Create match fragments for RAG analysis
 */
function createMatchFragments(matchData, participant, stats) {
    const duration = matchData.info.gameDuration;
    const earlyGame = duration >= 600; // 10 minutes
    const midGame = duration >= 1200; // 20 minutes
    const lateGame = duration >= 1800; // 30 minutes
    return {
        matchId: stats.matchId,
        puuid: stats.puuid,
        summary: `${participant.championName} ${stats.role} - ${stats.win ? 'Victory' : 'Defeat'} - ${stats.kills}/${stats.deaths}/${stats.assists} KDA`,
        performance: {
            kda: stats.kda,
            kills: stats.kills,
            deaths: stats.deaths,
            assists: stats.assists,
            csPerMin: stats.csPerMin,
            goldPerMin: stats.goldEarned / (duration / 60),
            damageShare: calculateDamageShare(matchData, participant),
            visionScore: stats.visionScore,
        },
        phases: {
            early: earlyGame ? `Early game (0-10min): CS advantage, lane pressure` : null,
            mid: midGame ? `Mid game (10-20min): Team fights, objective control` : null,
            late: lateGame ? `Late game (20+min): Scaling, positioning` : null,
        },
        keyMoments: extractKeyMoments(participant),
        itemBuild: participant.item0 ? [
            participant.item0,
            participant.item1,
            participant.item2,
            participant.item3,
            participant.item4,
            participant.item5,
        ].filter(Boolean) : [],
        timestamp: stats.timestamp,
    };
}
/**
 * Calculate player's damage share in the team
 */
function calculateDamageShare(matchData, participant) {
    const team = matchData.info.participants.filter((p) => p.teamId === participant.teamId);
    const totalTeamDamage = team.reduce((sum, p) => sum + p.totalDamageDealtToChampions, 0);
    return totalTeamDamage > 0
        ? (participant.totalDamageDealtToChampions / totalTeamDamage) * 100
        : 0;
}
/**
 * Extract key performance moments
 */
function extractKeyMoments(participant) {
    const moments = [];
    if (participant.firstBloodKill)
        moments.push('First Blood');
    if (participant.pentaKills > 0)
        moments.push(`${participant.pentaKills} Penta Kill${participant.pentaKills > 1 ? 's' : ''}`);
    if (participant.quadraKills > 0)
        moments.push(`${participant.quadraKills} Quadra Kill${participant.quadraKills > 1 ? 's' : ''}`);
    if (participant.tripleKills > 0)
        moments.push(`${participant.tripleKills} Triple Kill${participant.tripleKills > 1 ? 's' : ''}`);
    if (participant.killingSprees > 0)
        moments.push('Killing Spree');
    if (participant.largestMultiKill >= 2)
        moments.push(`${participant.largestMultiKill}x Multikill`);
    return moments;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrREFBa0Y7QUFDbEYsOERBQTBEO0FBQzFELHdEQUEyRTtBQUMzRSwwREFBcUU7QUFFckUsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2xDLE1BQU0sWUFBWSxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN6RSxNQUFNLFlBQVksR0FBRyxJQUFJLDRCQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFMUMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjLENBQUM7QUFDakQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7QUFDM0MsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFpQixDQUFDO0FBRXZELG9EQUFvRDtBQUNwRCxTQUFTLFlBQVksQ0FBQyxLQUFhLEVBQUUsTUFBYyxFQUFFLE9BQWU7SUFDbEUsT0FBTyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxNQUFNLENBQUM7QUFDckUsQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsRUFBVSxFQUFFLGVBQXVCO0lBQzVELE9BQU8sQ0FBQyxFQUFFLEdBQUcsZUFBZSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3JDLENBQUM7QUFRRDs7R0FFRztBQUNJLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUFzQixFQUFpQixFQUFFO0lBQ3JFLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBRXBELE1BQU0s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SSxDQUFDLEdBQUcsV0FBVyxDQUFDLFdBQVcsZUFBZSxXQUFXLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2pJLElBQUksV0FBVyxDQUFDLGFBQWEsR0FBRyxDQUFDO1FBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUNqRSxJQUFJLFdBQVcsQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDO1FBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsYUFBYSxDQUFDLENBQUM7SUFFbEcsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kLCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFB1dENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgTGFtYmRhQ2xpZW50LCBJbnZva2VDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWxhbWJkYSc7XG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcbmNvbnN0IGR5bmFtb0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShuZXcgRHluYW1vREJDbGllbnQoe30pKTtcbmNvbnN0IGxhbWJkYUNsaWVudCA9IG5ldyBMYW1iZGFDbGllbnQoe30pO1xuXG5jb25zdCBNQVRDSEVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuTUFUQ0hFU19UQUJMRSE7XG5jb25zdCBSQVdfQlVDS0VUID0gcHJvY2Vzcy5lbnYuUkFXX0JVQ0tFVCE7XG5jb25zdCBQUk9DRVNTRURfQlVDS0VUID0gcHJvY2Vzcy5lbnYuUFJPQ0VTU0VEX0JVQ0tFVCE7XG5cbi8vIFV0aWxpdHkgZnVuY3Rpb25zIChpbmxpbmUgdG8gYXZvaWQgaW1wb3J0IGlzc3VlcylcbmZ1bmN0aW9uIGNhbGN1bGF0ZUtEQShraWxsczogbnVtYmVyLCBkZWF0aHM6IG51bWJlciwgYXNzaXN0czogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIGRlYXRocyA9PT0gMCA/IGtpbGxzICsgYXNzaXN0cyA6IChraWxscyArIGFzc2lzdHMpIC8gZGVhdGhzO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDU1Blck1pbihjczogbnVtYmVyLCBkdXJhdGlvblNlY29uZHM6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiAoY3MgLyBkdXJhdGlvblNlY29uZHMpICogNjA7XG59XG5cbmludGVyZmFjZSBQcm9jZXNzaW5nRXZlbnQge1xuICBwdXVpZDogc3RyaW5nO1xuICBtYXRjaElkOiBzdHJpbmc7XG4gIHJlZ2lvbjogc3RyaW5nO1xufVxuXG4vKipcbiAqIFByb2Nlc3NpbmcgTGFtYmRhIC0gQ29tcHV0ZSBzdGF0cyBhbmQgY3JlYXRlIG1hdGNoIGZyYWdtZW50c1xuICovXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogUHJvY2Vzc2luZ0V2ZW50KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIExhbWJkYSBpbnZva2VkJywgeyBldmVudCB9KTtcblxuICBjb25zdCB7IHB1dWlkLCBtYXRjaElkLCByZWdpb24gfSA9IGV2ZW50O1xuXG4gIHRyeSB7XG4gICAgLy8gMS4gUmVhZCByYXcgbWF0Y2ggZGF0YSBmcm9tIFMzXG4gICAgY29uc3QgczNLZXkgPSBgJHtyZWdpb259LyR7cHV1aWR9LyR7bWF0Y2hJZH0uanNvbmA7XG4gICAgY29uc3QgZ2V0Q29tbWFuZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogUkFXX0JVQ0tFVCxcbiAgICAgIEtleTogczNLZXksXG4gICAgfSk7XG4gICAgXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKGdldENvbW1hbmQpO1xuICAgIGNvbnN0IG1hdGNoRGF0YSA9IEpTT04ucGFyc2UoYXdhaXQgcmVzcG9uc2UuQm9keSEudHJhbnNmb3JtVG9TdHJpbmcoKSk7XG4gICAgXG4gICAgY29uc29sZS5sb2coJ1JldHJpZXZlZCBtYXRjaCBkYXRhJywgeyBtYXRjaElkIH0pO1xuXG4gICAgLy8gMi4gRmluZCBwbGF5ZXIncyBwYXJ0aWNpcGFudCBkYXRhXG4gICAgY29uc3QgcGFydGljaXBhbnQgPSBtYXRjaERhdGEuaW5mby5wYXJ0aWNpcGFudHMuZmluZChcbiAgICAgIChwOiBhbnkpID0+IHAucHV1aWQgPT09IHB1dWlkXG4gICAgKTtcbiAgICBcbiAgICBpZiAoIXBhcnRpY2lwYW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBsYXllciAke3B1dWlkfSBub3QgZm91bmQgaW4gbWF0Y2ggJHttYXRjaElkfWApO1xuICAgIH1cblxuICAgIC8vIDMuIENvbXB1dGUgc3RhdGlzdGljc1xuICAgIC8vIENSSVRJQ0FMOiBwbGF5ZXJJZCBNVVNUIG1hdGNoIHRoZSBmb3JtYXQgdXNlZCBpbiBpbmdlc3Rpb24gTGFtYmRhXG4gICAgLy8gSW5nZXN0aW9uIHVzZXM6IHJlZ2lvbl9wdXVpZC5zbGljZSgwLDgpXG4gICAgLy8gRXhhbXBsZTogXCJLUjFfb3NLdVNLSU1cIiBub3QgXCJLUjFfRmFrZXJcIlxuICAgIGNvbnN0IHBsYXllcklkID0gYCR7cmVnaW9ufV8ke3B1dWlkLnNsaWNlKDAsIDgpfWA7XG4gICAgXG4gICAgY29uc3Qgc3RhdHMgPSB7XG4gICAgICBwbGF5ZXJJZCwgLy8gUkVRVUlSRUQ6IER5bmFtb0RCIHBhcnRpdGlvbiBrZXkgLSBNVVNUIG1hdGNoIGluZ2VzdGlvbiBmb3JtYXQhXG4gICAgICBtYXRjaElkLFxuICAgICAgcHV1aWQsXG4gICAgICBjaGFtcGlvbk5hbWU6IHBhcnRpY2lwYW50LmNoYW1waW9uTmFtZSxcbiAgICAgIGNoYW1waW9uSWQ6IHBhcnRpY2lwYW50LmNoYW1waW9uSWQsXG4gICAgICByb2xlOiBwYXJ0aWNpcGFudC50ZWFtUG9zaXRpb24gfHwgcGFydGljaXBhbnQuaW5kaXZpZHVhbFBvc2l0aW9uLFxuICAgICAga2lsbHM6IHBhcnRpY2lwYW50LmtpbGxzLFxuICAgICAgZGVhdGhzOiBwYXJ0aWNpcGFudC5kZWF0aHMsXG4gICAgICBhc3Npc3RzOiBwYXJ0aWNpcGFudC5hc3Npc3RzLFxuICAgICAga2RhOiBjYWxjdWxhdGVLREEocGFydGljaXBhbnQua2lsbHMsIHBhcnRpY2lwYW50LmRlYXRocywgcGFydGljaXBhbnQuYXNzaXN0cyksXG4gICAgICB0b3RhbENTOiBwYXJ0aWNpcGFudC50b3RhbE1pbmlvbnNLaWxsZWQgKyBwYXJ0aWNpcGFudC5uZXV0cmFsTWluaW9uc0tpbGxlZCxcbiAgICAgIGNzUGVyTWluOiBjYWxjdWxhdGVDU1Blck1pbihcbiAgICAgICAgcGFydGljaXBhbnQudG90YWxNaW5pb25zS2lsbGVkICsgcGFydGljaXBhbnQubmV1dHJhbE1pbmlvbnNLaWxsZWQsXG4gICAgICAgIG1hdGNoRGF0YS5pbmZvLmdhbWVEdXJhdGlvblxuICAgICAgKSxcbiAgICAgIGdvbGRFYXJuZWQ6IHBhcnRpY2lwYW50LmdvbGRFYXJuZWQsXG4gICAgICBkYW1hZ2VEZWFsdDogcGFydGljaXBhbnQudG90YWxEYW1hZ2VEZWFsdFRvQ2hhbXBpb25zLFxuICAgICAgZGFtYWdlVGFrZW46IHBhcnRpY2lwYW50LnRvdGFsRGFtYWdlVGFrZW4sXG4gICAgICB2aXNpb25TY29yZTogcGFydGljaXBhbnQudmlzaW9uU2NvcmUsXG4gICAgICB3aW46IHBhcnRpY2lwYW50LndpbixcbiAgICAgIGdhbWVEdXJhdGlvbjogbWF0Y2hEYXRhLmluZm8uZ2FtZUR1cmF0aW9uLFxuICAgICAgZ2FtZU1vZGU6IG1hdGNoRGF0YS5pbmZvLmdhbWVNb2RlLFxuICAgICAgcXVldWVJZDogbWF0Y2hEYXRhLmluZm8ucXVldWVJZCxcbiAgICAgIGdhbWVDcmVhdGlvbjogbWF0Y2hEYXRhLmluZm8uZ2FtZUNyZWF0aW9uLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShtYXRjaERhdGEuaW5mby5nYW1lQ3JlYXRpb24pLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIC8vIDQuIENyZWF0ZSBtYXRjaCBmcmFnbWVudHMgZm9yIFJBRyAoZWFybHkvbWlkL2xhdGUgZ2FtZSBhbmFseXNpcylcbiAgICBjb25zdCBmcmFnbWVudHMgPSBjcmVhdGVNYXRjaEZyYWdtZW50cyhtYXRjaERhdGEsIHBhcnRpY2lwYW50LCBzdGF0cyk7XG4gICAgXG4gICAgLy8gNS4gU3RvcmUgbWF0Y2ggc3RhdHMgaW4gRHluYW1vREJcbiAgICBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChcbiAgICAgIG5ldyBQdXRDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBNQVRDSEVTX1RBQkxFLFxuICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgLi4uc3RhdHMsXG4gICAgICAgICAgdHRsOiBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSArIDMwICogMjQgKiA2MCAqIDYwLCAvLyAzMCBkYXlzXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG4gICAgXG4gICAgY29uc29sZS5sb2coJ1N0b3JlZCBtYXRjaCBpbiBEeW5hbW9EQicsIHsgbWF0Y2hJZCB9KTtcblxuICAgIC8vIDYuIFN0b3JlIGZyYWdtZW50cyBpbiBwcm9jZXNzZWQgYnVja2V0XG4gICAgY29uc3QgZnJhZ21lbnRzS2V5ID0gYCR7cmVnaW9ufS8ke3B1dWlkfS8ke21hdGNoSWR9LWZyYWdtZW50cy5qc29uYDtcbiAgICBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFB1dE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IFBST0NFU1NFRF9CVUNLRVQsXG4gICAgICAgIEtleTogZnJhZ21lbnRzS2V5LFxuICAgICAgICBCb2R5OiBKU09OLnN0cmluZ2lmeShmcmFnbWVudHMpLFxuICAgICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgfSlcbiAgICApO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCdTdG9yZWQgZnJhZ21lbnRzIGluIFMzJywgeyBmcmFnbWVudHNLZXkgfSk7XG5cbiAgICAvLyA3LiBUcmlnZ2VyIEFJIExhbWJkYSBmb3IgaW5zaWdodCBnZW5lcmF0aW9uIChhc3luYylcbiAgICB0cnkge1xuICAgICAgYXdhaXQgbGFtYmRhQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBJbnZva2VDb21tYW5kKHtcbiAgICAgICAgICBGdW5jdGlvbk5hbWU6ICdyaWZ0LXJld2luZC1haScsXG4gICAgICAgICAgSW52b2NhdGlvblR5cGU6ICdFdmVudCcsIC8vIEFzeW5jIGludm9rZVxuICAgICAgICAgIFBheWxvYWQ6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIHB1dWlkLFxuICAgICAgICAgICAgbWF0Y2hJZCxcbiAgICAgICAgICAgIHJlZ2lvbixcbiAgICAgICAgICAgIGZyYWdtZW50c0tleSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgICBjb25zb2xlLmxvZygnVHJpZ2dlcmVkIEFJIExhbWJkYScsIHsgbWF0Y2hJZCB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gdHJpZ2dlciBBSSBMYW1iZGEgKG5vbi1jcml0aWNhbCk6JywgZXJyb3IpO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIGNvbXBsZXRlJywgeyBtYXRjaElkIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIHByb2Nlc3Npbmc6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG4vKipcbiAqIENyZWF0ZSBtYXRjaCBmcmFnbWVudHMgZm9yIFJBRyBhbmFseXNpc1xuICovXG5mdW5jdGlvbiBjcmVhdGVNYXRjaEZyYWdtZW50cyhtYXRjaERhdGE6IGFueSwgcGFydGljaXBhbnQ6IGFueSwgc3RhdHM6IGFueSkge1xuICBjb25zdCBkdXJhdGlvbiA9IG1hdGNoRGF0YS5pbmZvLmdhbWVEdXJhdGlvbjtcbiAgY29uc3QgZWFybHlHYW1lID0gZHVyYXRpb24gPj0gNjAwOyAvLyAxMCBtaW51dGVzXG4gIGNvbnN0IG1pZEdhbWUgPSBkdXJhdGlvbiA+PSAxMjAwOyAvLyAyMCBtaW51dGVzXG4gIGNvbnN0IGxhdGVHYW1lID0gZHVyYXRpb24gPj0gMTgwMDsgLy8gMzAgbWludXRlc1xuXG4gIHJldHVybiB7XG4gICAgbWF0Y2hJZDogc3RhdHMubWF0Y2hJZCxcbiAgICBwdXVpZDogc3RhdHMucHV1aWQsXG4gICAgc3VtbWFyeTogYCR7cGFydGljaXBhbnQuY2hhbXBpb25OYW1lfSAke3N0YXRzLnJvbGV9IC0gJHtzdGF0cy53aW4gPyAnVmljdG9yeScgOiAnRGVmZWF0J30gLSAke3N0YXRzLmtpbGxzfS8ke3N0YXRzLmRlYXRoc30vJHtzdGF0cy5hc3Npc3RzfSBLREFgLFxuICAgIFxuICAgIHBlcmZvcm1hbmNlOiB7XG4gICAgICBrZGE6IHN0YXRzLmtkYSxcbiAgICAgIGtpbGxzOiBzdGF0cy5raWxscyxcbiAgICAgIGRlYXRoczogc3RhdHMuZGVhdGhzLFxuICAgICAgYXNzaXN0czogc3RhdHMuYXNzaXN0cyxcbiAgICAgIGNzUGVyTWluOiBzdGF0cy5jc1Blck1pbixcbiAgICAgIGdvbGRQZXJNaW46IHN0YXRzLmdvbGRFYXJuZWQgLyAoZHVyYXRpb24gLyA2MCksXG4gICAgICBkYW1hZ2VTaGFyZTogY2FsY3VsYXRlRGFtYWdlU2hhcmUobWF0Y2hEYXRhLCBwYXJ0aWNpcGFudCksXG4gICAgICB2aXNpb25TY29yZTogc3RhdHMudmlzaW9uU2NvcmUsXG4gICAgfSxcbiAgICBcbiAgICBwaGFzZXM6IHtcbiAgICAgIGVhcmx5OiBlYXJseUdhbWUgPyBgRWFybHkgZ2FtZSAoMC0xMG1pbik6IENTIGFkdmFudGFnZSwgbGFuZSBwcmVzc3VyZWAgOiBudWxsLFxuICAgICAgbWlkOiBtaWRHYW1lID8gYE1pZCBnYW1lICgxMC0yMG1pbik6IFRlYW0gZmlnaHRzLCBvYmplY3RpdmUgY29udHJvbGAgOiBudWxsLFxuICAgICAgbGF0ZTogbGF0ZUdhbWUgPyBgTGF0ZSBnYW1lICgyMCttaW4pOiBTY2FsaW5nLCBwb3NpdGlvbmluZ2AgOiBudWxsLFxuICAgIH0sXG4gICAgXG4gICAga2V5TW9tZW50czogZXh0cmFjdEtleU1vbWVudHMocGFydGljaXBhbnQpLFxuICAgIFxuICAgIGl0ZW1CdWlsZDogcGFydGljaXBhbnQuaXRlbTAgPyBbXG4gICAgICBwYXJ0aWNpcGFudC5pdGVtMCxcbiAgICAgIHBhcnRpY2lwYW50Lml0ZW0xLFxuICAgICAgcGFydGljaXBhbnQuaXRlbTIsXG4gICAgICBwYXJ0aWNpcGFudC5pdGVtMyxcbiAgICAgIHBhcnRpY2lwYW50Lml0ZW00LFxuICAgICAgcGFydGljaXBhbnQuaXRlbTUsXG4gICAgXS5maWx0ZXIoQm9vbGVhbikgOiBbXSxcbiAgICBcbiAgICB0aW1lc3RhbXA6IHN0YXRzLnRpbWVzdGFtcCxcbiAgfTtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgcGxheWVyJ3MgZGFtYWdlIHNoYXJlIGluIHRoZSB0ZWFtXG4gKi9cbmZ1bmN0aW9uIGNhbGN1bGF0ZURhbWFnZVNoYXJlKG1hdGNoRGF0YTogYW55LCBwYXJ0aWNpcGFudDogYW55KTogbnVtYmVyIHtcbiAgY29uc3QgdGVhbSA9IG1hdGNoRGF0YS5pbmZvLnBhcnRpY2lwYW50cy5maWx0ZXIoXG4gICAgKHA6IGFueSkgPT4gcC50ZWFtSWQgPT09IHBhcnRpY2lwYW50LnRlYW1JZFxuICApO1xuICBjb25zdCB0b3RhbFRlYW1EYW1hZ2UgPSB0ZWFtLnJlZHVjZShcbiAgICAoc3VtOiBudW1iZXIsIHA6IGFueSkgPT4gc3VtICsgcC50b3RhbERhbWFnZURlYWx0VG9DaGFtcGlvbnMsXG4gICAgMFxuICApO1xuICByZXR1cm4gdG90YWxUZWFtRGFtYWdlID4gMFxuICAgID8gKHBhcnRpY2lwYW50LnRvdGFsRGFtYWdlRGVhbHRUb0NoYW1waW9ucyAvIHRvdGFsVGVhbURhbWFnZSkgKiAxMDBcbiAgICA6IDA7XG59XG5cbi8qKlxuICogRXh0cmFjdCBrZXkgcGVyZm9ybWFuY2UgbW9tZW50c1xuICovXG5mdW5jdGlvbiBleHRyYWN0S2V5TW9tZW50cyhwYXJ0aWNpcGFudDogYW55KSB7XG4gIGNvbnN0IG1vbWVudHMgPSBbXTtcbiAgXG4gIGlmIChwYXJ0aWNpcGFudC5maXJzdEJsb29kS2lsbCkgbW9tZW50cy5wdXNoKCdGaXJzdCBCbG9vZCcpO1xuICBpZiAocGFydGljaXBhbnQucGVudGFLaWxscyA+IDApIG1vbWVudHMucHVzaChgJHtwYXJ0aWNpcGFudC5wZW50YUtpbGxzfSBQZW50YSBLaWxsJHtwYXJ0aWNpcGFudC5wZW50YUtpbGxzID4gMSA/ICdzJyA6ICcnfWApO1xuICBpZiAocGFydGljaXBhbnQucXVhZHJhS2lsbHMgPiAwKSBtb21lbnRzLnB1c2goYCR7cGFydGljaXBhbnQucXVhZHJhS2lsbHN9IFF1YWRyYSBLaWxsJHtwYXJ0aWNpcGFudC5xdWFkcmFLaWxscyA+IDEgPyAncycgOiAnJ31gKTtcbiAgaWYgKHBhcnRpY2lwYW50LnRyaXBsZUtpbGxzID4gMCkgbW9tZW50cy5wdXNoKGAke3BhcnRpY2lwYW50LnRyaXBsZUtpbGxzfSBUcmlwbGUgS2lsbCR7cGFydGljaXBhbnQudHJpcGxlS2lsbHMgPiAxID8gJ3MnIDogJyd9YCk7XG4gIGlmIChwYXJ0aWNpcGFudC5raWxsaW5nU3ByZWVzID4gMCkgbW9tZW50cy5wdXNoKCdLaWxsaW5nIFNwcmVlJyk7XG4gIGlmIChwYXJ0aWNpcGFudC5sYXJnZXN0TXVsdGlLaWxsID49IDIpIG1vbWVudHMucHVzaChgJHtwYXJ0aWNpcGFudC5sYXJnZXN0TXVsdGlLaWxsfXggTXVsdGlraWxsYCk7XG4gIFxuICByZXR1cm4gbW9tZW50cztcbn1cbiJdfQ==