"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_lambda_1 = require("@aws-sdk/client-lambda");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const riot_client_1 = require("./riot-client");
/**
 * Ingestion Lambda - Fetch match data from Riot API
 *
 * This function:
 * 1. Receives a player summoner name + region
 * 2. Fetches match history from Riot API
 * 3. Stores raw data in S3
 * 4. Saves player record to DynamoDB
 * 5. Triggers processing pipeline
 */
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const lambdaClient = new client_lambda_1.LambdaClient({ region: process.env.AWS_REGION });
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
const RAW_BUCKET = process.env.RAW_BUCKET;
const PLAYERS_TABLE = process.env.PLAYERS_TABLE;
const PROCESSING_LAMBDA = process.env.PROCESSING_LAMBDA || 'rift-rewind-processing';
const RIOT_API_KEY = process.env.RIOT_API_KEY || 'RGAPI-demo-key';
const handler = async (event) => {
    console.log('Ingestion Lambda invoked', { event });
    // Handle OPTIONS preflight request
    if (event.httpMethod === 'OPTIONS') {
        return {
            statusCode: 200,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            },
            body: '',
        };
    }
    try {
        // Parse request body
        const body = event.body
            ? JSON.parse(event.body)
            : { summonerName: 'Demo', region: 'NA1' };
        const { summonerName, region, maxMatches = 50 } = body;
        console.log('Fetching data for:', { summonerName, region, maxMatches });
        // Initialize Riot API client
        const riotClient = new riot_client_1.RiotClient(RIOT_API_KEY, region);
        // Step 1: Get player PUUID using Riot ID format (gameName#tagLine)
        // If summonerName contains '#', split it; otherwise use summonerName as gameName and region as tagLine
        let puuid;
        let gameName;
        let tagLine;
        if (summonerName.includes('#')) {
            const [name, tag] = summonerName.split('#');
            gameName = name;
            tagLine = tag;
            const result = await riotClient.getSummonerByRiotId(gameName, tagLine);
            puuid = result.puuid;
        }
        else {
            // Fallback: try old API (may not work for all accounts)
            gameName = summonerName;
            tagLine = region.replace('1', ''); // NA1 -> NA
            const result = await riotClient.getSummonerByRiotId(gameName, tagLine);
            puuid = result.puuid;
        }
        const playerId = `${region}_${puuid.slice(0, 8)}`;
        console.log('Player found:', { playerId, puuid, gameName, tagLine });
        // Step 2: Save player to DynamoDB
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: PLAYERS_TABLE,
            Item: {
                playerId: { S: playerId },
                puuid: { S: puuid },
                summonerName: { S: `${gameName}#${tagLine}` },
                region: { S: region },
                lastUpdated: { S: new Date().toISOString() },
            },
        }));
        console.log('Player saved to DynamoDB');
        // Step 3: Fetch match IDs
        const matchIds = await riotClient.getMatchIds(puuid, 0, Math.min(maxMatches, 100));
        console.log(`Found ${matchIds.length} matches`);
        // Step 4: Fetch and store each match
        const storedMatches = [];
        for (let i = 0; i < Math.min(matchIds.length, maxMatches); i++) {
            const matchId = matchIds[i];
            try {
                console.log(`Fetching match ${i + 1}/${matchIds.length}: ${matchId}`);
                const matchData = await riotClient.getMatch(matchId);
                // Store raw match data in S3
                const key = `${region}/${puuid}/${matchId}.json`;
                await s3Client.send(new client_s3_1.PutObjectCommand({
                    Bucket: RAW_BUCKET,
                    Key: key,
                    Body: JSON.stringify(matchData),
                    ContentType: 'application/json',
                }));
                storedMatches.push(matchId);
                console.log(`Stored match ${matchId} to S3`);
                // Small delay to avoid rate limiting (Riot API is strict)
                if (i < matchIds.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            catch (error) {
                console.error(`Failed to fetch match ${matchId}:`, error);
                // Continue with other matches
            }
        }
        console.log(`Successfully stored ${storedMatches.length} matches`);
        // Step 5: Trigger processing Lambda for each match
        if (storedMatches.length > 0) {
            console.log(`Triggering processing for ${storedMatches.length} matches`);
            for (const matchId of storedMatches) {
                try {
                    await lambdaClient.send(new client_lambda_1.InvokeCommand({
                        FunctionName: PROCESSING_LAMBDA,
                        InvocationType: 'Event', // Async invocation
                        Payload: JSON.stringify({
                            puuid,
                            matchId,
                            region,
                        }),
                    }));
                    console.log(`Processing Lambda triggered for match ${matchId}`);
                }
                catch (error) {
                    console.error(`Failed to trigger processing Lambda for match ${matchId}:`, error);
                    // Non-fatal - match is stored in S3, can be reprocessed later
                }
            }
        }
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            },
            body: JSON.stringify({
                message: 'Ingestion completed successfully',
                puuid,
                summonerName,
                region,
                matchesFetched: storedMatches.length,
                totalMatches: matchIds.length,
            }),
        };
    }
    catch (error) {
        console.error('Error in ingestion:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            },
            body: JSON.stringify({
                error: 'Internal server error',
                message: error instanceof Error ? error.message : 'Unknown error',
                details: error instanceof Error ? error.stack : undefined,
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBZ0U7QUFDaEUsMERBQXFFO0FBQ3JFLDhEQUEwRTtBQUMxRSwrQ0FBMkM7QUFFM0M7Ozs7Ozs7OztHQVNHO0FBRUgsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztBQUNsRSxNQUFNLFlBQVksR0FBRyxJQUFJLDRCQUFZLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQzFFLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7QUFFNUUsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7QUFDM0MsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjLENBQUM7QUFDakQsTUFBTSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixJQUFJLHdCQUF3QixDQUFDO0FBQ3BGLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLGdCQUFnQixDQUFDO0FBUTNELE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBRW5ELG1DQUFtQztJQUNuQyxJQUFJLEtBQUssQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDbkMsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFO2dCQUNQLDZCQUE2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WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBTM0NsaWVudCwgUHV0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBMYW1iZGFDbGllbnQsIEludm9rZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBSaW90Q2xpZW50IH0gZnJvbSAnLi9yaW90LWNsaWVudCc7XG5cbi8qKlxuICogSW5nZXN0aW9uIExhbWJkYSAtIEZldGNoIG1hdGNoIGRhdGEgZnJvbSBSaW90IEFQSVxuICogXG4gKiBUaGlzIGZ1bmN0aW9uOlxuICogMS4gUmVjZWl2ZXMgYSBwbGF5ZXIgc3VtbW9uZXIgbmFtZSArIHJlZ2lvblxuICogMi4gRmV0Y2hlcyBtYXRjaCBoaXN0b3J5IGZyb20gUmlvdCBBUElcbiAqIDMuIFN0b3JlcyByYXcgZGF0YSBpbiBTM1xuICogNC4gU2F2ZXMgcGxheWVyIHJlY29yZCB0byBEeW5hbW9EQlxuICogNS4gVHJpZ2dlcnMgcHJvY2Vzc2luZyBwaXBlbGluZVxuICovXG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pO1xuY29uc3QgbGFtYmRhQ2xpZW50ID0gbmV3IExhbWJkYUNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB9KTtcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB9KTtcblxuY29uc3QgUkFXX0JVQ0tFVCA9IHByb2Nlc3MuZW52LlJBV19CVUNLRVQhO1xuY29uc3QgUExBWUVSU19UQUJMRSA9IHByb2Nlc3MuZW52LlBMQVlFUlNfVEFCTEUhO1xuY29uc3QgUFJPQ0VTU0lOR19MQU1CREEgPSBwcm9jZXNzLmVudi5QUk9DRVNTSU5HX0xBTUJEQSB8fCAncmlmdC1yZXdpbmQtcHJvY2Vzc2luZyc7XG5jb25zdCBSSU9UX0FQSV9LRVkgPSBwcm9jZXNzLmVudi5SSU9UX0FQSV9LRVkgfHwgJ1JHQVBJLWRlbW8ta2V5JztcblxuaW50ZXJmYWNlIEluZ2VzdGlvblJlcXVlc3Qge1xuICBzdW1tb25lck5hbWU6IHN0cmluZztcbiAgcmVnaW9uOiBzdHJpbmc7XG4gIG1heE1hdGNoZXM/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdJbmdlc3Rpb24gTGFtYmRhIGludm9rZWQnLCB7IGV2ZW50IH0pO1xuXG4gIC8vIEhhbmRsZSBPUFRJT05TIHByZWZsaWdodCByZXF1ZXN0XG4gIGlmIChldmVudC5odHRwTWV0aG9kID09PSAnT1BUSU9OUycpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdQT1NULCBPUFRJT05TJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiAnJyxcbiAgICB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBQYXJzZSByZXF1ZXN0IGJvZHlcbiAgICBjb25zdCBib2R5OiBJbmdlc3Rpb25SZXF1ZXN0ID0gZXZlbnQuYm9keSBcbiAgICAgID8gSlNPTi5wYXJzZShldmVudC5ib2R5KSBcbiAgICAgIDogeyBzdW1tb25lck5hbWU6ICdEZW1vJywgcmVnaW9uOiAnTkExJyB9O1xuXG4gICAgY29uc3QgeyBzdW1tb25lck5hbWUsIHJlZ2lvbiwgbWF4TWF0Y2hlcyA9IDUwIH0gPSBib2R5O1xuXG4gICAgY29uc29sZS5sb2coJ0ZldGNoaW5nIGRhdGEgZm9yOicsIHsgc3VtbW9uZXJOYW1lLCByZWdpb24sIG1heE1hdGNoZXMgfSk7XG5cbiAgICAvLyBJbml0aWFsaXplIFJpb3QgQVBJIGNsaWVudFxuICAgIGNvbnN0IHJpb3RDbGllbnQgPSBuZXcgUmlvdENsaWVudChSSU9UX0FQSV9LRVksIHJlZ2lvbik7XG5cbiAgICAvLyBTdGVwIDE6IEdldCBwbGF5ZXIgUFVVSUQgdXNpbmcgUmlvdCBJRCBmb3JtYXQgKGdhbWVOYW1lI3RhZ0xpbmUpXG4gICAgLy8gSWYgc3VtbW9uZXJOYW1lIGNvbnRhaW5zICcjJywgc3BsaXQgaXQ7IG90aGVyd2lzZSB1c2Ugc3VtbW9uZXJOYW1lIGFzIGdhbWVOYW1lIGFuZCByZWdpb24gYXMgdGFnTGluZVxuICAgIGxldCBwdXVpZDogc3RyaW5nO1xuICAgIGxldCBnYW1lTmFtZTogc3RyaW5nO1xuICAgIGxldCB0YWdMaW5lOiBzdHJpbmc7XG4gICAgXG4gICAgaWYgKHN1bW1vbmVyTmFtZS5pbmNsdWRlcygnIycpKSB7XG4gICAgICBjb25zdCBbbmFtZSwgdGFnXSA9IHN1bW1vbmVyTmFtZS5zcGxpdCgnIycpO1xuICAgICAgZ2FtZU5hbWUgPSBuYW1lO1xuICAgICAgdGFnTGluZSA9IHRhZztcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJpb3RDbGllbnQuZ2V0U3VtbW9uZXJCeVJpb3RJZChnYW1lTmFtZSwgdGFnTGluZSk7XG4gICAgICBwdXVpZCA9IHJlc3VsdC5wdXVpZDtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRmFsbGJhY2s6IHRyeSBvbGQgQVBJIChtYXkgbm90IHdvcmsgZm9yIGFsbCBhY2NvdW50cylcbiAgICAgIGdhbWVOYW1lID0gc3VtbW9uZXJOYW1lO1xuICAgICAgdGFnTGluZSA9IHJlZ2lvbi5yZXBsYWNlKCcxJywgJycpOyAvLyBOQTEgLT4gTkFcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJpb3RDbGllbnQuZ2V0U3VtbW9uZXJCeVJpb3RJZChnYW1lTmFtZSwgdGFnTGluZSk7XG4gICAgICBwdXVpZCA9IHJlc3VsdC5wdXVpZDtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgcGxheWVySWQgPSBgJHtyZWdpb259XyR7cHV1aWQuc2xpY2UoMCwgOCl9YDtcblxuICAgIGNvbnNvbGUubG9nKCdQbGF5ZXIgZm91bmQ6JywgeyBwbGF5ZXJJZCwgcHV1aWQsIGdhbWVOYW1lLCB0YWdMaW5lIH0pO1xuXG4gICAgLy8gU3RlcCAyOiBTYXZlIHBsYXllciB0byBEeW5hbW9EQlxuICAgIGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBQTEFZRVJTX1RBQkxFLFxuICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgcGxheWVySWQ6IHsgUzogcGxheWVySWQgfSxcbiAgICAgICAgICBwdXVpZDogeyBTOiBwdXVpZCB9LFxuICAgICAgICAgIHN1bW1vbmVyTmFtZTogeyBTOiBgJHtnYW1lTmFtZX0jJHt0YWdMaW5lfWAgfSxcbiAgICAgICAgICByZWdpb246IHsgUzogcmVnaW9uIH0sXG4gICAgICAgICAgbGFzdFVwZGF0ZWQ6IHsgUzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zb2xlLmxvZygnUGxheWVyIHNhdmVkIHRvIER5bmFtb0RCJyk7XG5cbiAgICAvLyBTdGVwIDM6IEZldGNoIG1hdGNoIElEc1xuICAgIGNvbnN0IG1hdGNoSWRzID0gYXdhaXQgcmlvdENsaWVudC5nZXRNYXRjaElkcyhwdXVpZCwgMCwgTWF0aC5taW4obWF4TWF0Y2hlcywgMTAwKSk7XG4gICAgY29uc29sZS5sb2coYEZvdW5kICR7bWF0Y2hJZHMubGVuZ3RofSBtYXRjaGVzYCk7XG5cbiAgICAvLyBTdGVwIDQ6IEZldGNoIGFuZCBzdG9yZSBlYWNoIG1hdGNoXG4gICAgY29uc3Qgc3RvcmVkTWF0Y2hlczogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKG1hdGNoSWRzLmxlbmd0aCwgbWF4TWF0Y2hlcyk7IGkrKykge1xuICAgICAgY29uc3QgbWF0Y2hJZCA9IG1hdGNoSWRzW2ldO1xuICAgICAgXG4gICAgICB0cnkge1xuICAgICAgICBjb25zb2xlLmxvZyhgRmV0Y2hpbmcgbWF0Y2ggJHtpICsgMX0vJHttYXRjaElkcy5sZW5ndGh9OiAke21hdGNoSWR9YCk7XG4gICAgICAgIGNvbnN0IG1hdGNoRGF0YSA9IGF3YWl0IHJpb3RDbGllbnQuZ2V0TWF0Y2gobWF0Y2hJZCk7XG5cbiAgICAgICAgLy8gU3RvcmUgcmF3IG1hdGNoIGRhdGEgaW4gUzNcbiAgICAgICAgY29uc3Qga2V5ID0gYCR7cmVnaW9ufS8ke3B1dWlkfS8ke21hdGNoSWR9Lmpzb25gO1xuICAgICAgICBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogUkFXX0JVQ0tFVCxcbiAgICAgICAgICAgIEtleToga2V5LFxuICAgICAgICAgICAgQm9keTogSlNPTi5zdHJpbmdpZnkobWF0Y2hEYXRhKSxcbiAgICAgICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBzdG9yZWRNYXRjaGVzLnB1c2gobWF0Y2hJZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBTdG9yZWQgbWF0Y2ggJHttYXRjaElkfSB0byBTM2ApO1xuXG4gICAgICAgIC8vIFNtYWxsIGRlbGF5IHRvIGF2b2lkIHJhdGUgbGltaXRpbmcgKFJpb3QgQVBJIGlzIHN0cmljdClcbiAgICAgICAgaWYgKGkgPCBtYXRjaElkcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMCkpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZmV0Y2ggbWF0Y2ggJHttYXRjaElkfTpgLCBlcnJvcik7XG4gICAgICAgIC8vIENvbnRpbnVlIHdpdGggb3RoZXIgbWF0Y2hlc1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgc3RvcmVkICR7c3RvcmVkTWF0Y2hlcy5sZW5ndGh9IG1hdGNoZXNgKTtcblxuICAgIC8vIFN0ZXAgNTogVHJpZ2dlciBwcm9jZXNzaW5nIExhbWJkYSBmb3IgZWFjaCBtYXRjaFxuICAgIGlmIChzdG9yZWRNYXRjaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKGBUcmlnZ2VyaW5nIHByb2Nlc3NpbmcgZm9yICR7c3RvcmVkTWF0Y2hlcy5sZW5ndGh9IG1hdGNoZXNgKTtcbiAgICAgIFxuICAgICAgZm9yIChjb25zdCBtYXRjaElkIG9mIHN0b3JlZE1hdGNoZXMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBsYW1iZGFDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBJbnZva2VDb21tYW5kKHtcbiAgICAgICAgICAgICAgRnVuY3Rpb25OYW1lOiBQUk9DRVNTSU5HX0xBTUJEQSxcbiAgICAgICAgICAgICAgSW52b2NhdGlvblR5cGU6ICdFdmVudCcsIC8vIEFzeW5jIGludm9jYXRpb25cbiAgICAgICAgICAgICAgUGF5bG9hZDogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIHB1dWlkLFxuICAgICAgICAgICAgICAgIG1hdGNoSWQsXG4gICAgICAgICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyBMYW1iZGEgdHJpZ2dlcmVkIGZvciBtYXRjaCAke21hdGNoSWR9YCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHRyaWdnZXIgcHJvY2Vzc2luZyBMYW1iZGEgZm9yIG1hdGNoICR7bWF0Y2hJZH06YCwgZXJyb3IpO1xuICAgICAgICAgIC8vIE5vbi1mYXRhbCAtIG1hdGNoIGlzIHN0b3JlZCBpbiBTMywgY2FuIGJlIHJlcHJvY2Vzc2VkIGxhdGVyXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdQT1NULCBPUFRJT05TJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIG1lc3NhZ2U6ICdJbmdlc3Rpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIHB1dWlkLFxuICAgICAgICBzdW1tb25lck5hbWUsXG4gICAgICAgIHJlZ2lvbixcbiAgICAgICAgbWF0Y2hlc0ZldGNoZWQ6IHN0b3JlZE1hdGNoZXMubGVuZ3RoLFxuICAgICAgICB0b3RhbE1hdGNoZXM6IG1hdGNoSWRzLmxlbmd0aCxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gaW5nZXN0aW9uOicsIGVycm9yKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdQT1NULCBPUFRJT05TJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgIGRldGFpbHM6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cbn07XG4iXX0=