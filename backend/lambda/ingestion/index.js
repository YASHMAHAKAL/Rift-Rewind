"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_lambda_1 = require("@aws-sdk/client-lambda");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const riot_client_1 = require("../../lib/riot-client");
/**
 * Ingestion Lambda - Fetch match data from Riot API
 *
 * This function:
 * 1. Receives a player summoner name + region
 * 2. Fetches match history from Riot API
 * 3. Stores raw data in S3
 * 4. Saves player record to DynamoDB
 * 5. Triggers processing pipeline
 */
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const lambdaClient = new client_lambda_1.LambdaClient({ region: process.env.AWS_REGION });
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
const RAW_BUCKET = process.env.RAW_BUCKET;
const PLAYERS_TABLE = process.env.PLAYERS_TABLE;
const PROCESSING_LAMBDA = process.env.PROCESSING_LAMBDA || 'rift-rewind-processing';
const RIOT_API_KEY = process.env.RIOT_API_KEY || 'RGAPI-demo-key';
const handler = async (event) => {
    console.log('Ingestion Lambda invoked', { event });
    try {
        // Parse request body
        const body = event.body
            ? JSON.parse(event.body)
            : { summonerName: 'Demo', region: 'NA1' };
        const { summonerName, region, maxMatches = 50 } = body;
        console.log('Fetching data for:', { summonerName, region, maxMatches });
        // Initialize Riot API client
        const riotClient = new riot_client_1.RiotClient(RIOT_API_KEY, region);
        // Step 1: Get player PUUID
        const { puuid, summonerId } = await riotClient.getSummonerByName(summonerName);
        const playerId = `${region}_${puuid.slice(0, 8)}`;
        console.log('Player found:', { playerId, puuid, summonerId });
        // Step 2: Save player to DynamoDB
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: PLAYERS_TABLE,
            Item: {
                playerId: { S: playerId },
                puuid: { S: puuid },
                summonerName: { S: summonerName },
                region: { S: region },
                summonerId: { S: summonerId },
                lastUpdated: { S: new Date().toISOString() },
            },
        }));
        console.log('Player saved to DynamoDB');
        // Step 3: Fetch match IDs
        const matchIds = await riotClient.getMatchIds(puuid, 0, Math.min(maxMatches, 100));
        console.log(`Found ${matchIds.length} matches`);
        // Step 4: Fetch and store each match
        const storedMatches = [];
        for (let i = 0; i < Math.min(matchIds.length, maxMatches); i++) {
            const matchId = matchIds[i];
            try {
                console.log(`Fetching match ${i + 1}/${matchIds.length}: ${matchId}`);
                const matchData = await riotClient.getMatch(matchId);
                // Store raw match data in S3
                const key = `${playerId}/${matchId}.json`;
                await s3Client.send(new client_s3_1.PutObjectCommand({
                    Bucket: RAW_BUCKET,
                    Key: key,
                    Body: JSON.stringify(matchData),
                    ContentType: 'application/json',
                }));
                storedMatches.push(matchId);
                console.log(`Stored match ${matchId} to S3`);
                // Small delay to avoid rate limiting (Riot API is strict)
                if (i < matchIds.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            catch (error) {
                console.error(`Failed to fetch match ${matchId}:`, error);
                // Continue with other matches
            }
        }
        console.log(`Successfully stored ${storedMatches.length} matches`);
        // Step 5: Trigger processing Lambda
        if (storedMatches.length > 0) {
            try {
                await lambdaClient.send(new client_lambda_1.InvokeCommand({
                    FunctionName: PROCESSING_LAMBDA,
                    InvocationType: 'Event', // Async invocation
                    Payload: JSON.stringify({
                        playerId,
                        region,
                        matchIds: storedMatches,
                    }),
                }));
                console.log('Processing Lambda triggered');
            }
            catch (error) {
                console.error('Failed to trigger processing Lambda:', error);
                // Non-fatal - matches are stored, can be reprocessed later
            }
        }
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
                message: 'Ingestion completed successfully',
                playerId,
                summonerName,
                region,
                matchesFetched: storedMatches.length,
                totalMatches: matchIds.length,
            }),
        };
    }
    catch (error) {
        console.error('Error in ingestion:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
                error: 'Internal server error',
                message: error instanceof Error ? error.message : 'Unknown error',
                details: error instanceof Error ? error.stack : undefined,
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBZ0U7QUFDaEUsMERBQXFFO0FBQ3JFLDhEQUEwRTtBQUMxRSx1REFBbUQ7QUFFbkQ7Ozs7Ozs7OztHQVNHO0FBRUgsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztBQUNsRSxNQUFNLFlBQVksR0FBRyxJQUFJLDRCQUFZLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQzFFLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7QUFFNUUsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7QUFDM0MsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjLENBQUM7QUFDakQsTUFBTSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixJQUFJLHdCQUF3QixDQUFDO0FBQ3BGLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLGdCQUFnQixDQUFDO0FBUTNELE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBRW5ELElBQUksQ0FBQztRQUNILHFCQUFxQjtRQUNyQixNQUFNLElBQUksR0FBcUIsS0FBSyxDQUFDLElBQUk7WUFDdkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUks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LEtBQUssQ0FBQyxDQUFDO2dCQUM3RCwyREFBMkQ7WUFDN0QsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUU7Z0JBQ1AsY0FBYyxFQUFFLGtCQUFrQjtnQkFDbEMsNkJBQTZCLEVBQUUsR0FBRzthQUNuQztZQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixPQUFPLEVBQUUsa0NBQWtDO2dCQUMzQyxRQUFRO2dCQUNSLFlBQVk7Z0JBQ1osTUFBTTtnQkFDTixjQUFjLEVBQUUsYUFBYSxDQUFDLE1BQU07Z0JBQ3BDLFlBQVksRUFBRSxRQUFRLENBQUMsTUFBTTthQUM5QixDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU1QyxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUU7Z0JBQ1AsY0FBYyxFQUFFLGtCQUFrQjtnQkFDbEMsNkJBQTZCLEVBQUUsR0FBRzthQUNuQztZQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixLQUFLLEVBQUUsdUJBQXVCO2dCQUM5QixPQUFPLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtnQkFDakUsT0FBTyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVM7YUFDMUQsQ0FBQztTQUNILENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBbElXLFFBQUEsT0FBTyxXQWtJbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBTM0NsaWVudCwgUHV0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBMYW1iZGFDbGllbnQsIEludm9rZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBSaW90Q2xpZW50IH0gZnJvbSAnLi4vLi4vbGliL3Jpb3QtY2xpZW50JztcblxuLyoqXG4gKiBJbmdlc3Rpb24gTGFtYmRhIC0gRmV0Y2ggbWF0Y2ggZGF0YSBmcm9tIFJpb3QgQVBJXG4gKiBcbiAqIFRoaXMgZnVuY3Rpb246XG4gKiAxLiBSZWNlaXZlcyBhIHBsYXllciBzdW1tb25lciBuYW1lICsgcmVnaW9uXG4gKiAyLiBGZXRjaGVzIG1hdGNoIGhpc3RvcnkgZnJvbSBSaW90IEFQSVxuICogMy4gU3RvcmVzIHJhdyBkYXRhIGluIFMzXG4gKiA0LiBTYXZlcyBwbGF5ZXIgcmVjb3JkIHRvIER5bmFtb0RCXG4gKiA1LiBUcmlnZ2VycyBwcm9jZXNzaW5nIHBpcGVsaW5lXG4gKi9cblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5jb25zdCBsYW1iZGFDbGllbnQgPSBuZXcgTGFtYmRhQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pO1xuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pO1xuXG5jb25zdCBSQVdfQlVDS0VUID0gcHJvY2Vzcy5lbnYuUkFXX0JVQ0tFVCE7XG5jb25zdCBQTEFZRVJTX1RBQkxFID0gcHJvY2Vzcy5lbnYuUExBWUVSU19UQUJMRSE7XG5jb25zdCBQUk9DRVNTSU5HX0xBTUJEQSA9IHByb2Nlc3MuZW52LlBST0NFU1NJTkdfTEFNQkRBIHx8ICdyaWZ0LXJld2luZC1wcm9jZXNzaW5nJztcbmNvbnN0IFJJT1RfQVBJX0tFWSA9IHByb2Nlc3MuZW52LlJJT1RfQVBJX0tFWSB8fCAnUkdBUEktZGVtby1rZXknO1xuXG5pbnRlcmZhY2UgSW5nZXN0aW9uUmVxdWVzdCB7XG4gIHN1bW1vbmVyTmFtZTogc3RyaW5nO1xuICByZWdpb246IHN0cmluZztcbiAgbWF4TWF0Y2hlcz86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ0luZ2VzdGlvbiBMYW1iZGEgaW52b2tlZCcsIHsgZXZlbnQgfSk7XG5cbiAgdHJ5IHtcbiAgICAvLyBQYXJzZSByZXF1ZXN0IGJvZHlcbiAgICBjb25zdCBib2R5OiBJbmdlc3Rpb25SZXF1ZXN0ID0gZXZlbnQuYm9keSBcbiAgICAgID8gSlNPTi5wYXJzZShldmVudC5ib2R5KSBcbiAgICAgIDogeyBzdW1tb25lck5hbWU6ICdEZW1vJywgcmVnaW9uOiAnTkExJyB9O1xuXG4gICAgY29uc3QgeyBzdW1tb25lck5hbWUsIHJlZ2lvbiwgbWF4TWF0Y2hlcyA9IDUwIH0gPSBib2R5O1xuXG4gICAgY29uc29sZS5sb2coJ0ZldGNoaW5nIGRhdGEgZm9yOicsIHsgc3VtbW9uZXJOYW1lLCByZWdpb24sIG1heE1hdGNoZXMgfSk7XG5cbiAgICAvLyBJbml0aWFsaXplIFJpb3QgQVBJIGNsaWVudFxuICAgIGNvbnN0IHJpb3RDbGllbnQgPSBuZXcgUmlvdENsaWVudChSSU9UX0FQSV9LRVksIHJlZ2lvbik7XG5cbiAgICAvLyBTdGVwIDE6IEdldCBwbGF5ZXIgUFVVSURcbiAgICBjb25zdCB7IHB1dWlkLCBzdW1tb25lcklkIH0gPSBhd2FpdCByaW90Q2xpZW50LmdldFN1bW1vbmVyQnlOYW1lKHN1bW1vbmVyTmFtZSk7XG4gICAgY29uc3QgcGxheWVySWQgPSBgJHtyZWdpb259XyR7cHV1aWQuc2xpY2UoMCwgOCl9YDtcblxuICAgIGNvbnNvbGUubG9nKCdQbGF5ZXIgZm91bmQ6JywgeyBwbGF5ZXJJZCwgcHV1aWQsIHN1bW1vbmVySWQgfSk7XG5cbiAgICAvLyBTdGVwIDI6IFNhdmUgcGxheWVyIHRvIER5bmFtb0RCXG4gICAgYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IFBMQVlFUlNfVEFCTEUsXG4gICAgICAgIEl0ZW06IHtcbiAgICAgICAgICBwbGF5ZXJJZDogeyBTOiBwbGF5ZXJJZCB9LFxuICAgICAgICAgIHB1dWlkOiB7IFM6IHB1dWlkIH0sXG4gICAgICAgICAgc3VtbW9uZXJOYW1lOiB7IFM6IHN1bW1vbmVyTmFtZSB9LFxuICAgICAgICAgIHJlZ2lvbjogeyBTOiByZWdpb24gfSxcbiAgICAgICAgICBzdW1tb25lcklkOiB7IFM6IHN1bW1vbmVySWQgfSxcbiAgICAgICAgICBsYXN0VXBkYXRlZDogeyBTOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnNvbGUubG9nKCdQbGF5ZXIgc2F2ZWQgdG8gRHluYW1vREInKTtcblxuICAgIC8vIFN0ZXAgMzogRmV0Y2ggbWF0Y2ggSURzXG4gICAgY29uc3QgbWF0Y2hJZHMgPSBhd2FpdCByaW90Q2xpZW50LmdldE1hdGNoSWRzKHB1dWlkLCAwLCBNYXRoLm1pbihtYXhNYXRjaGVzLCAxMDApKTtcbiAgICBjb25zb2xlLmxvZyhgRm91bmQgJHttYXRjaElkcy5sZW5ndGh9IG1hdGNoZXNgKTtcblxuICAgIC8vIFN0ZXAgNDogRmV0Y2ggYW5kIHN0b3JlIGVhY2ggbWF0Y2hcbiAgICBjb25zdCBzdG9yZWRNYXRjaGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTWF0aC5taW4obWF0Y2hJZHMubGVuZ3RoLCBtYXhNYXRjaGVzKTsgaSsrKSB7XG4gICAgICBjb25zdCBtYXRjaElkID0gbWF0Y2hJZHNbaV07XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBGZXRjaGluZyBtYXRjaCAke2kgKyAxfS8ke21hdGNoSWRzLmxlbmd0aH06ICR7bWF0Y2hJZH1gKTtcbiAgICAgICAgY29uc3QgbWF0Y2hEYXRhID0gYXdhaXQgcmlvdENsaWVudC5nZXRNYXRjaChtYXRjaElkKTtcblxuICAgICAgICAvLyBTdG9yZSByYXcgbWF0Y2ggZGF0YSBpbiBTM1xuICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF5ZXJJZH0vJHttYXRjaElkfS5qc29uYDtcbiAgICAgICAgYXdhaXQgczNDbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgICAgICAgICBCdWNrZXQ6IFJBV19CVUNLRVQsXG4gICAgICAgICAgICBLZXk6IGtleSxcbiAgICAgICAgICAgIEJvZHk6IEpTT04uc3RyaW5naWZ5KG1hdGNoRGF0YSksXG4gICAgICAgICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgc3RvcmVkTWF0Y2hlcy5wdXNoKG1hdGNoSWQpO1xuICAgICAgICBjb25zb2xlLmxvZyhgU3RvcmVkIG1hdGNoICR7bWF0Y2hJZH0gdG8gUzNgKTtcblxuICAgICAgICAvLyBTbWFsbCBkZWxheSB0byBhdm9pZCByYXRlIGxpbWl0aW5nIChSaW90IEFQSSBpcyBzdHJpY3QpXG4gICAgICAgIGlmIChpIDwgbWF0Y2hJZHMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGZldGNoIG1hdGNoICR7bWF0Y2hJZH06YCwgZXJyb3IpO1xuICAgICAgICAvLyBDb250aW51ZSB3aXRoIG90aGVyIG1hdGNoZXNcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhgU3VjY2Vzc2Z1bGx5IHN0b3JlZCAke3N0b3JlZE1hdGNoZXMubGVuZ3RofSBtYXRjaGVzYCk7XG5cbiAgICAvLyBTdGVwIDU6IFRyaWdnZXIgcHJvY2Vzc2luZyBMYW1iZGFcbiAgICBpZiAoc3RvcmVkTWF0Y2hlcy5sZW5ndGggPiAwKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBsYW1iZGFDbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgSW52b2tlQ29tbWFuZCh7XG4gICAgICAgICAgICBGdW5jdGlvbk5hbWU6IFBST0NFU1NJTkdfTEFNQkRBLFxuICAgICAgICAgICAgSW52b2NhdGlvblR5cGU6ICdFdmVudCcsIC8vIEFzeW5jIGludm9jYXRpb25cbiAgICAgICAgICAgIFBheWxvYWQ6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgcGxheWVySWQsXG4gICAgICAgICAgICAgIHJlZ2lvbixcbiAgICAgICAgICAgICAgbWF0Y2hJZHM6IHN0b3JlZE1hdGNoZXMsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyBMYW1iZGEgdHJpZ2dlcmVkJyk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gdHJpZ2dlciBwcm9jZXNzaW5nIExhbWJkYTonLCBlcnJvcik7XG4gICAgICAgIC8vIE5vbi1mYXRhbCAtIG1hdGNoZXMgYXJlIHN0b3JlZCwgY2FuIGJlIHJlcHJvY2Vzc2VkIGxhdGVyXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIG1lc3NhZ2U6ICdJbmdlc3Rpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIHBsYXllcklkLFxuICAgICAgICBzdW1tb25lck5hbWUsXG4gICAgICAgIHJlZ2lvbixcbiAgICAgICAgbWF0Y2hlc0ZldGNoZWQ6IHN0b3JlZE1hdGNoZXMubGVuZ3RoLFxuICAgICAgICB0b3RhbE1hdGNoZXM6IG1hdGNoSWRzLmxlbmd0aCxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gaW5nZXN0aW9uOicsIGVycm9yKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgZGV0YWlsczogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==