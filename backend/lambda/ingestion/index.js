"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_lambda_1 = require("@aws-sdk/client-lambda");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const riot_client_1 = require("./riot-client");
/**
 * Ingestion Lambda - Fetch match data from Riot API
 *
 * This function:
 * 1. Receives a player summoner name + region
 * 2. Fetches match history from Riot API
 * 3. Stores raw data in S3
 * 4. Saves player record to DynamoDB
 * 5. Triggers processing pipeline
 */
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const lambdaClient = new client_lambda_1.LambdaClient({ region: process.env.AWS_REGION });
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
const RAW_BUCKET = process.env.RAW_BUCKET;
const PLAYERS_TABLE = process.env.PLAYERS_TABLE;
const PROCESSING_LAMBDA = process.env.PROCESSING_LAMBDA || 'rift-rewind-processing';
const RIOT_API_KEY = process.env.RIOT_API_KEY || 'RGAPI-demo-key';
const handler = async (event) => {
    console.log('Ingestion Lambda invoked', { event });
    // Handle OPTIONS preflight request
    if (event.httpMethod === 'OPTIONS') {
        return {
            statusCode: 200,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            },
            body: '',
        };
    }
    try {
        // Parse request body
        const body = event.body
            ? JSON.parse(event.body)
            : { summonerName: 'Demo', region: 'NA1' };
        const { summonerName, region, maxMatches = 50 } = body;
        console.log('Fetching data for:', { summonerName, region, maxMatches });
        // Initialize Riot API client
        const riotClient = new riot_client_1.RiotClient(RIOT_API_KEY, region);
        // Step 1: Get player PUUID using Riot ID format (gameName#tagLine)
        // If summonerName contains '#', split it; otherwise use summonerName as gameName and region as tagLine
        let puuid;
        let gameName;
        let tagLine;
        if (summonerName.includes('#')) {
            const [name, tag] = summonerName.split('#');
            gameName = name;
            tagLine = tag;
            const result = await riotClient.getSummonerByRiotId(gameName, tagLine);
            puuid = result.puuid;
        }
        else {
            // Fallback: try old API (may not work for all accounts)
            gameName = summonerName;
            tagLine = region.replace('1', ''); // NA1 -> NA
            const result = await riotClient.getSummonerByRiotId(gameName, tagLine);
            puuid = result.puuid;
        }
        const playerId = `${region}_${puuid.slice(0, 8)}`;
        console.log('Player found:', { playerId, puuid, gameName, tagLine });
        // Step 2: Save player to DynamoDB
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: PLAYERS_TABLE,
            Item: {
                playerId: { S: playerId },
                puuid: { S: puuid },
                summonerName: { S: `${gameName}#${tagLine}` },
                region: { S: region },
                lastUpdated: { S: new Date().toISOString() },
            },
        }));
        console.log('Player saved to DynamoDB');
        // Step 3: Fetch match IDs
        const matchIds = await riotClient.getMatchIds(puuid, 0, Math.min(maxMatches, 100));
        console.log(`Found ${matchIds.length} matches`);
        // Step 4: Fetch and store each match
        const storedMatches = [];
        for (let i = 0; i < Math.min(matchIds.length, maxMatches); i++) {
            const matchId = matchIds[i];
            try {
                console.log(`Fetching match ${i + 1}/${matchIds.length}: ${matchId}`);
                const matchData = await riotClient.getMatch(matchId);
                // Store raw match data in S3
                const key = `${playerId}/${matchId}.json`;
                await s3Client.send(new client_s3_1.PutObjectCommand({
                    Bucket: RAW_BUCKET,
                    Key: key,
                    Body: JSON.stringify(matchData),
                    ContentType: 'application/json',
                }));
                storedMatches.push(matchId);
                console.log(`Stored match ${matchId} to S3`);
                // Small delay to avoid rate limiting (Riot API is strict)
                if (i < matchIds.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            catch (error) {
                console.error(`Failed to fetch match ${matchId}:`, error);
                // Continue with other matches
            }
        }
        console.log(`Successfully stored ${storedMatches.length} matches`);
        // Step 5: Trigger processing Lambda
        if (storedMatches.length > 0) {
            try {
                await lambdaClient.send(new client_lambda_1.InvokeCommand({
                    FunctionName: PROCESSING_LAMBDA,
                    InvocationType: 'Event', // Async invocation
                    Payload: JSON.stringify({
                        playerId,
                        region,
                        matchIds: storedMatches,
                    }),
                }));
                console.log('Processing Lambda triggered');
            }
            catch (error) {
                console.error('Failed to trigger processing Lambda:', error);
                // Non-fatal - matches are stored, can be reprocessed later
            }
        }
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            },
            body: JSON.stringify({
                message: 'Ingestion completed successfully',
                puuid,
                summonerName,
                region,
                matchesFetched: storedMatches.length,
                totalMatches: matchIds.length,
            }),
        };
    }
    catch (error) {
        console.error('Error in ingestion:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            },
            body: JSON.stringify({
                error: 'Internal server error',
                message: error instanceof Error ? error.message : 'Unknown error',
                details: error instanceof Error ? error.stack : undefined,
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBZ0U7QUFDaEUsMERBQXFFO0FBQ3JFLDhEQUEwRTtBQUMxRSwrQ0FBMkM7QUFFM0M7Ozs7Ozs7OztHQVNHO0FBRUgsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztBQUNsRSxNQUFNLFlBQVksR0FBRyxJQUFJLDRCQUFZLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQzFFLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7QUFFNUUsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7QUFDM0MsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjLENBQUM7QUFDakQsTUFBTSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixJQUFJLHdCQUF3QixDQUFDO0FBQ3BGLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLGdCQUFnQixDQUFDO0FBUTNELE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBRW5ELG1DQUFtQztJQUNuQyxJQUFJLEtBQUssQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDbkMsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFO2dCQUNQLDZCQUE2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QUUsZUFBZTtnQkFDL0MsOEJBQThCLEVBQUUsNkJBQTZCO2FBQzlEO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSxrQ0FBa0M7Z0JBQzNDLEtBQUs7Z0JBQ0wsWUFBWTtnQkFDWixNQUFNO2dCQUNOLGNBQWMsRUFBRSxhQUFhLENBQUMsTUFBTTtnQkFDcEMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxNQUFNO2FBQzlCLENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTVDLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRTtnQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2dCQUNsQyw2QkFBNkIsRUFBRSxHQUFHO2dCQUNsQyw4QkFBOEIsRUFBRSxlQUFlO2dCQUMvQyw4QkFBOEIsRUFBRSw2QkFBNkI7YUFDOUQ7WUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDbkIsS0FBSyxFQUFFLHVCQUF1QjtnQkFDOUIsT0FBTyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7Z0JBQ2pFLE9BQU8sRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTO2FBQzFELENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMsQ0FBQztBQXBLVyxRQUFBLE9BQU8sV0FvS2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgUzNDbGllbnQsIFB1dE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgTGFtYmRhQ2xpZW50LCBJbnZva2VDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgUmlvdENsaWVudCB9IGZyb20gJy4vcmlvdC1jbGllbnQnO1xuXG4vKipcbiAqIEluZ2VzdGlvbiBMYW1iZGEgLSBGZXRjaCBtYXRjaCBkYXRhIGZyb20gUmlvdCBBUElcbiAqIFxuICogVGhpcyBmdW5jdGlvbjpcbiAqIDEuIFJlY2VpdmVzIGEgcGxheWVyIHN1bW1vbmVyIG5hbWUgKyByZWdpb25cbiAqIDIuIEZldGNoZXMgbWF0Y2ggaGlzdG9yeSBmcm9tIFJpb3QgQVBJXG4gKiAzLiBTdG9yZXMgcmF3IGRhdGEgaW4gUzNcbiAqIDQuIFNhdmVzIHBsYXllciByZWNvcmQgdG8gRHluYW1vREJcbiAqIDUuIFRyaWdnZXJzIHByb2Nlc3NpbmcgcGlwZWxpbmVcbiAqL1xuXG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB9KTtcbmNvbnN0IGxhbWJkYUNsaWVudCA9IG5ldyBMYW1iZGFDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5cbmNvbnN0IFJBV19CVUNLRVQgPSBwcm9jZXNzLmVudi5SQVdfQlVDS0VUITtcbmNvbnN0IFBMQVlFUlNfVEFCTEUgPSBwcm9jZXNzLmVudi5QTEFZRVJTX1RBQkxFITtcbmNvbnN0IFBST0NFU1NJTkdfTEFNQkRBID0gcHJvY2Vzcy5lbnYuUFJPQ0VTU0lOR19MQU1CREEgfHwgJ3JpZnQtcmV3aW5kLXByb2Nlc3NpbmcnO1xuY29uc3QgUklPVF9BUElfS0VZID0gcHJvY2Vzcy5lbnYuUklPVF9BUElfS0VZIHx8ICdSR0FQSS1kZW1vLWtleSc7XG5cbmludGVyZmFjZSBJbmdlc3Rpb25SZXF1ZXN0IHtcbiAgc3VtbW9uZXJOYW1lOiBzdHJpbmc7XG4gIHJlZ2lvbjogc3RyaW5nO1xuICBtYXhNYXRjaGVzPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnSW5nZXN0aW9uIExhbWJkYSBpbnZva2VkJywgeyBldmVudCB9KTtcblxuICAvLyBIYW5kbGUgT1BUSU9OUyBwcmVmbGlnaHQgcmVxdWVzdFxuICBpZiAoZXZlbnQuaHR0cE1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnUE9TVCwgT1BUSU9OUycsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSwgQXV0aG9yaXphdGlvbicsXG4gICAgICB9LFxuICAgICAgYm9keTogJycsXG4gICAgfTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgLy8gUGFyc2UgcmVxdWVzdCBib2R5XG4gICAgY29uc3QgYm9keTogSW5nZXN0aW9uUmVxdWVzdCA9IGV2ZW50LmJvZHkgXG4gICAgICA/IEpTT04ucGFyc2UoZXZlbnQuYm9keSkgXG4gICAgICA6IHsgc3VtbW9uZXJOYW1lOiAnRGVtbycsIHJlZ2lvbjogJ05BMScgfTtcblxuICAgIGNvbnN0IHsgc3VtbW9uZXJOYW1lLCByZWdpb24sIG1heE1hdGNoZXMgPSA1MCB9ID0gYm9keTtcblxuICAgIGNvbnNvbGUubG9nKCdGZXRjaGluZyBkYXRhIGZvcjonLCB7IHN1bW1vbmVyTmFtZSwgcmVnaW9uLCBtYXhNYXRjaGVzIH0pO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBSaW90IEFQSSBjbGllbnRcbiAgICBjb25zdCByaW90Q2xpZW50ID0gbmV3IFJpb3RDbGllbnQoUklPVF9BUElfS0VZLCByZWdpb24pO1xuXG4gICAgLy8gU3RlcCAxOiBHZXQgcGxheWVyIFBVVUlEIHVzaW5nIFJpb3QgSUQgZm9ybWF0IChnYW1lTmFtZSN0YWdMaW5lKVxuICAgIC8vIElmIHN1bW1vbmVyTmFtZSBjb250YWlucyAnIycsIHNwbGl0IGl0OyBvdGhlcndpc2UgdXNlIHN1bW1vbmVyTmFtZSBhcyBnYW1lTmFtZSBhbmQgcmVnaW9uIGFzIHRhZ0xpbmVcbiAgICBsZXQgcHV1aWQ6IHN0cmluZztcbiAgICBsZXQgZ2FtZU5hbWU6IHN0cmluZztcbiAgICBsZXQgdGFnTGluZTogc3RyaW5nO1xuICAgIFxuICAgIGlmIChzdW1tb25lck5hbWUuaW5jbHVkZXMoJyMnKSkge1xuICAgICAgY29uc3QgW25hbWUsIHRhZ10gPSBzdW1tb25lck5hbWUuc3BsaXQoJyMnKTtcbiAgICAgIGdhbWVOYW1lID0gbmFtZTtcbiAgICAgIHRhZ0xpbmUgPSB0YWc7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByaW90Q2xpZW50LmdldFN1bW1vbmVyQnlSaW90SWQoZ2FtZU5hbWUsIHRhZ0xpbmUpO1xuICAgICAgcHV1aWQgPSByZXN1bHQucHV1aWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEZhbGxiYWNrOiB0cnkgb2xkIEFQSSAobWF5IG5vdCB3b3JrIGZvciBhbGwgYWNjb3VudHMpXG4gICAgICBnYW1lTmFtZSA9IHN1bW1vbmVyTmFtZTtcbiAgICAgIHRhZ0xpbmUgPSByZWdpb24ucmVwbGFjZSgnMScsICcnKTsgLy8gTkExIC0+IE5BXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByaW90Q2xpZW50LmdldFN1bW1vbmVyQnlSaW90SWQoZ2FtZU5hbWUsIHRhZ0xpbmUpO1xuICAgICAgcHV1aWQgPSByZXN1bHQucHV1aWQ7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IHBsYXllcklkID0gYCR7cmVnaW9ufV8ke3B1dWlkLnNsaWNlKDAsIDgpfWA7XG5cbiAgICBjb25zb2xlLmxvZygnUGxheWVyIGZvdW5kOicsIHsgcGxheWVySWQsIHB1dWlkLCBnYW1lTmFtZSwgdGFnTGluZSB9KTtcblxuICAgIC8vIFN0ZXAgMjogU2F2ZSBwbGF5ZXIgdG8gRHluYW1vREJcbiAgICBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChcbiAgICAgIG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogUExBWUVSU19UQUJMRSxcbiAgICAgICAgSXRlbToge1xuICAgICAgICAgIHBsYXllcklkOiB7IFM6IHBsYXllcklkIH0sXG4gICAgICAgICAgcHV1aWQ6IHsgUzogcHV1aWQgfSxcbiAgICAgICAgICBzdW1tb25lck5hbWU6IHsgUzogYCR7Z2FtZU5hbWV9IyR7dGFnTGluZX1gIH0sXG4gICAgICAgICAgcmVnaW9uOiB7IFM6IHJlZ2lvbiB9LFxuICAgICAgICAgIGxhc3RVcGRhdGVkOiB7IFM6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc29sZS5sb2coJ1BsYXllciBzYXZlZCB0byBEeW5hbW9EQicpO1xuXG4gICAgLy8gU3RlcCAzOiBGZXRjaCBtYXRjaCBJRHNcbiAgICBjb25zdCBtYXRjaElkcyA9IGF3YWl0IHJpb3RDbGllbnQuZ2V0TWF0Y2hJZHMocHV1aWQsIDAsIE1hdGgubWluKG1heE1hdGNoZXMsIDEwMCkpO1xuICAgIGNvbnNvbGUubG9nKGBGb3VuZCAke21hdGNoSWRzLmxlbmd0aH0gbWF0Y2hlc2ApO1xuXG4gICAgLy8gU3RlcCA0OiBGZXRjaCBhbmQgc3RvcmUgZWFjaCBtYXRjaFxuICAgIGNvbnN0IHN0b3JlZE1hdGNoZXM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLm1pbihtYXRjaElkcy5sZW5ndGgsIG1heE1hdGNoZXMpOyBpKyspIHtcbiAgICAgIGNvbnN0IG1hdGNoSWQgPSBtYXRjaElkc1tpXTtcbiAgICAgIFxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc29sZS5sb2coYEZldGNoaW5nIG1hdGNoICR7aSArIDF9LyR7bWF0Y2hJZHMubGVuZ3RofTogJHttYXRjaElkfWApO1xuICAgICAgICBjb25zdCBtYXRjaERhdGEgPSBhd2FpdCByaW90Q2xpZW50LmdldE1hdGNoKG1hdGNoSWQpO1xuXG4gICAgICAgIC8vIFN0b3JlIHJhdyBtYXRjaCBkYXRhIGluIFMzXG4gICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXllcklkfS8ke21hdGNoSWR9Lmpzb25gO1xuICAgICAgICBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogUkFXX0JVQ0tFVCxcbiAgICAgICAgICAgIEtleToga2V5LFxuICAgICAgICAgICAgQm9keTogSlNPTi5zdHJpbmdpZnkobWF0Y2hEYXRhKSxcbiAgICAgICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBzdG9yZWRNYXRjaGVzLnB1c2gobWF0Y2hJZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBTdG9yZWQgbWF0Y2ggJHttYXRjaElkfSB0byBTM2ApO1xuXG4gICAgICAgIC8vIFNtYWxsIGRlbGF5IHRvIGF2b2lkIHJhdGUgbGltaXRpbmcgKFJpb3QgQVBJIGlzIHN0cmljdClcbiAgICAgICAgaWYgKGkgPCBtYXRjaElkcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMCkpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZmV0Y2ggbWF0Y2ggJHttYXRjaElkfTpgLCBlcnJvcik7XG4gICAgICAgIC8vIENvbnRpbnVlIHdpdGggb3RoZXIgbWF0Y2hlc1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgc3RvcmVkICR7c3RvcmVkTWF0Y2hlcy5sZW5ndGh9IG1hdGNoZXNgKTtcblxuICAgIC8vIFN0ZXAgNTogVHJpZ2dlciBwcm9jZXNzaW5nIExhbWJkYVxuICAgIGlmIChzdG9yZWRNYXRjaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGxhbWJkYUNsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBJbnZva2VDb21tYW5kKHtcbiAgICAgICAgICAgIEZ1bmN0aW9uTmFtZTogUFJPQ0VTU0lOR19MQU1CREEsXG4gICAgICAgICAgICBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JywgLy8gQXN5bmMgaW52b2NhdGlvblxuICAgICAgICAgICAgUGF5bG9hZDogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICBwbGF5ZXJJZCxcbiAgICAgICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgICAgICBtYXRjaElkczogc3RvcmVkTWF0Y2hlcyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIExhbWJkYSB0cmlnZ2VyZWQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byB0cmlnZ2VyIHByb2Nlc3NpbmcgTGFtYmRhOicsIGVycm9yKTtcbiAgICAgICAgLy8gTm9uLWZhdGFsIC0gbWF0Y2hlcyBhcmUgc3RvcmVkLCBjYW4gYmUgcmVwcm9jZXNzZWQgbGF0ZXJcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdQT1NULCBPUFRJT05TJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIG1lc3NhZ2U6ICdJbmdlc3Rpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIHB1dWlkLFxuICAgICAgICBzdW1tb25lck5hbWUsXG4gICAgICAgIHJlZ2lvbixcbiAgICAgICAgbWF0Y2hlc0ZldGNoZWQ6IHN0b3JlZE1hdGNoZXMubGVuZ3RoLFxuICAgICAgICB0b3RhbE1hdGNoZXM6IG1hdGNoSWRzLmxlbmd0aCxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gaW5nZXN0aW9uOicsIGVycm9yKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdQT1NULCBPUFRJT05TJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgIGRldGFpbHM6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cbn07XG4iXX0=