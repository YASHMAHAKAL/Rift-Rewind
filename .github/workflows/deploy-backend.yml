name: Deploy Backend

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: CDK Deploy
        run: npx cdk deploy --all --require-approval never
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: us-east-1

      - name: Update endpoints.json files
        working-directory: .
        run: |
          API_ENDPOINT=$(aws cloudformation describe-stacks --stack-name RiftRewindStack --query 'Stacks[0].Outputs[?OutputKey==`APIEndpoint`].OutputValue' --output text)
          CLOUDFRONT_ID=$(aws cloudfront list-distributions --output json | grep -E '"Id".*E[A-Z0-9]{12,13}' | head -1 | awk -F'"' '{print $4}')
          CLOUDFRONT_DOMAIN=$(echo "${CLOUDFRONT_ID}" | tr '[:upper:]' '[:lower:]')
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          echo "✅ API Endpoint: $API_ENDPOINT"
          echo "✅ CloudFront ID: $CLOUDFRONT_ID"
          
          # Update shared/endpoints.json
          cat > shared/endpoints.json <<EOF
          {
            "apiEndpoint": "${API_ENDPOINT}",
            "cloudFrontUrl": "https://d${CLOUDFRONT_DOMAIN}.cloudfront.net",
            "region": "us-east-1",
            "accountId": "${{ secrets.AWS_ACCOUNT_ID }}",
            "timestamp": "${TIMESTAMP}"
          }
          EOF
          
          # Copy to frontend/public/endpoints.json
          cp shared/endpoints.json frontend/public/endpoints.json
          
          echo "✅ Updated endpoints.json files"

      - name: Commit updated endpoints
        working-directory: .
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add shared/endpoints.json frontend/public/endpoints.json
          if ! git diff --quiet HEAD; then
            git commit -m "chore: update API endpoints after backend deployment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
